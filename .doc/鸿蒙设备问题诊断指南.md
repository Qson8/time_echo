# 鸿蒙设备问题诊断指南

## 问题
开启语音设置开关后，下次启动App时，开关状态无法恢复。

## 诊断步骤

### 第一步：查看保存流程（开启开关时）

在开启语音开关时，查看日志，应该能看到：

```
保存用户设置到本地存储:
  保存 voiceEnabled: true
  保存结果: true
更新语音设置: voiceEnabled=true
========== 语音设置更新完成 ==========
```

**如果看不到这个日志** → 说明保存流程有问题

### 第二步：查看启动流程（下次启动时）

在启动应用时，查看日志，应该能看到：

#### 2.1 SharedPreferences 初始化
```
SharedPreferences 初始化成功
或
SharedPreferences 初始化失败，使用内存存储: ...
```

#### 2.2 从数据库加载设置
```
加载布尔设置: voiceEnabled = true (字符串)
从数据库加载了 X 个设置项
内存存储内容: {voiceEnabled: true, ...}
```

#### 2.3 加载用户设置
```
========== 开始加载用户设置 ==========
从本地存储读取设置...
getBool(keyVoiceEnabled): 内存中的值 = true (类型: String)
getBool(keyVoiceEnabled): 字符串 "true" 转换为布尔值 true
  voiceEnabled: true
  加载结果: voiceEnabled: true (类型: bool)
```

#### 2.4 UI构建
```
🔍 SettingsScreen build() 被调用
🔍 Consumer2 builder 被调用: voiceEnabled=true
🔍 _buildVoiceSection: voiceEnabled=true
```

### 第三步：诊断结果

根据日志，可以判断问题在哪一步：

#### 情况A：没有看到任何保存日志
❌ **问题**：开关点击事件没有触发
✅ **解决**：检查 `_toggleVoice()` 方法是否被正确调用

#### 情况B：保存成功，但启动时没有加载
❌ **问题**：从数据库加载失败
✅ **查看**：
- 是否看到 "从数据库加载了 0 个设置项" → 说明数据库中没有数据
- 是否看到 "从数据库加载设置失败" → 说明数据库访问异常

#### 情况C：加载成功，但UI没有更新
❌ **问题**：UI没有响应状态变化
✅ **查看**：
- Consumer2 builder 是否被调用？
- voiceEnabled 的值是什么？
- 是否有 "Consumer2 builder 被调用: voiceEnabled=false" 但实际应该是 true？

#### 情况D：数据类型转换问题
❌ **问题**：布尔值转换错误
✅ **查看**：
- 是否看到 "getBool(keyVoiceEnabled): 字符串 'true' 转换为布尔值 true"？
- 如果没有，说明类型转换有问题

## 测试步骤

1. **清理日志**（可选）
   ```bash
   adb logcat -c
   ```

2. **开启语音开关**
   - 打开App
   - 进入设置页面
   - 开启"拾光语音读题"开关
   - 查看日志，确认保存流程

3. **重启App**
   - 完全关闭App
   - 重新启动App
   - 进入设置页面
   - 查看启动日志，确认加载流程

4. **检查结果**
   - 查看开关是否自动开启
   - 查看日志，确认每一步都正常

## 日志关键字

在查看日志时，搜索以下关键字：

- `保存用户设置` - 检查保存流程
- `从数据库加载` - 检查加载流程
- `getBool` - 检查类型转换
- `voiceEnabled` - 检查状态值
- `Consumer2 builder` - 检查UI更新

## 常见问题

### Q1: 看到 "从数据库加载了 0 个设置项"
**原因**：数据库中确实没有保存数据
**排查**：
1. 检查保存时是否成功
2. 检查数据库文件位置
3. 手动检查数据库内容

### Q2: voiceEnabled 一直是 false
**原因**：可能是类型转换问题
**排查**：
1. 查看 "getBool" 相关的日志
2. 查看 "内存存储内容" 的值
3. 确认数据库中的值是 'true' 而不是其他值

### Q3: Consumer2 builder 没有被调用
**原因**：UI没有监听状态变化
**排查**：
1. 确认 SettingsScreen 使用了 Consumer2
2. 确认 AppStateProvider 已经初始化
3. 确认 notifyListeners() 被调用

## 手动检查数据库（高级）

如果需要手动检查数据库内容：

```bash
# 1. 查找数据库文件
adb shell "find /data/data/com.example.time_echo -name '*.db'"

# 2. 检查数据库内容（需要root权限）
adb shell
su
sqlite3 /data/data/com.example.time_echo/databases/time_echo.db
SELECT * FROM user_settings WHERE key='voiceEnabled';
```

