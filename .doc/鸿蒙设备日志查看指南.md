# 鸿蒙设备日志查看指南

## 📋 日志标记说明

代码中使用了以下emoji标记来区分不同类型的日志：

- 🚀 **开关操作**：用户点击开关时的操作日志
- 💾 **保存操作**：数据保存到存储的日志
- 📖 **读取操作**：从存储读取数据的日志
- 🔍 **UI更新**：UI构建和更新时的日志
- ✅ **成功**：操作成功的标识
- ❌ **失败**：操作失败的标识
- ⚠️ **警告**：需要注意的情况
- 📢 **通知**：notifyListeners相关日志
- 📝 **状态更新**：应用状态变化的日志

## 🔍 测试步骤

### 第一步：开启语音开关

1. 启动应用
2. 进入**设置**页面
3. 打开**拾光语音读题**开关
4. 查看日志

**预期日志：**
```
🚀 _toggleVoice 被调用，新值: true
🚀 当前状态: voiceEnabled=false, voiceSpeed=中
🚀 开始调用 updateVoiceSettings...
========== 更新语音设置 ==========
📝 当前状态: voiceEnabled=false, voiceSpeed=中
📝 新状态: voiceEnabled=true, voiceSpeed=中
📝 内部状态已更新: _voiceEnabled=true
1. 保存到本地存储...
  保存用户设置到本地存储:
    保存 voiceEnabled: true
💾 setBool(voiceEnabled, true) 开始执行
💾 _useMemoryStorage = true
💾 已保存到内存: _memoryStorage[voiceEnabled] = true
💾 ✅ 已保存到数据库: voiceEnabled = true
  保存结果: true
   ✅ 保存到本地存储完成
2. 更新语音服务...
   ✅ 语音服务已更新
3. 通知UI更新...
   📢 调用 notifyListeners() 前: _voiceEnabled=true
   ✅ notifyListeners() 已完成
========== 语音设置更新完成 ==========
🚀 updateVoiceSettings 完成
🚀 更新后状态: voiceEnabled=true
```

### 第二步：查看UI是否正确更新

开启开关后，应该立即看到：
```
🔍 SettingsScreen build() 被调用
🔍 Consumer2 builder 被调用: voiceEnabled=true
🔍 _buildVoiceSection: voiceEnabled=true
```

### 第三步：重启应用

1. 完全关闭应用
2. 重新启动应用
3. 查看启动日志

**预期启动日志：**
```
SharedPreferences 初始化失败，使用内存存储: ...
加载布尔设置: voiceEnabled = true (字符串)
从数据库加载了 X 个设置项
内存存储内容: {voiceEnabled: true, ...}
========== 开始加载用户设置 ==========
从本地存储读取设置...
📖 getBool(voiceEnabled) 开始执行
📖 _useMemory無存 = true
📖 内存中的值 = true (类型: String)
📖 ✅ 字符串 "true" 转换为布尔值 true
   voiceEnabled: true
   加载结果: voiceEnabled: true (类型: bool)
```

### 第四步：进入设置页面

重启后进入设置页面，应该看到：
```
🔍 SettingsScreen build() 被调用
🔍 Consumer2 builder 被调用: voiceEnabled=true
🔍 _buildVoiceSection: voiceEnabled=true
```

## 🔧 如何查看日志

### 方法1：Android Studio Logcat

1. 打开 Logcat 窗口
2. 在搜索框中输入：`🚀|💾|📖|🔍`
3. 或者搜索：`voiceEnabled`

### 方法2：命令行（adb）

```bash
# 清除旧日志
adb logcat -c

# 查看所有带有emoji标记的日志
adb logcat | grep -E "🚀|💾|📖|🔍|voiceEnabled"

# 或者查看所有日志并保存到文件
adb log记录下来 | tee logcat.txt
```

### 方法3：实时监控

```bash
# 实时查看日志，只显示关键日志
adb logcat | grep -E "voiceEnabled|保存|读取|UI|Consumer"
```

## 🐛 问题诊断

### 问题1：没有看到🚀日志

**症状**：开关被点击但没有看到 `🚀 _toggleVoice 被调用`

**原因**：开关的 `onChanged` 回调没有正确绑定

**排查**：
- 检查 `_buildSwitchTile` 中的 `onChanged` 参数
- 确认开关可以正常点击

### 问题2：看到了🚀日志但没有💾日志

**症状**：`🚀 _toggleVoice 被调用` 后面没有 `💾 setBool` 日志

**原因**：`updateVoiceSettings` 方法没有被调用或中途出错

**排查**：
- 查看是否有错误日志 `❌`
- 检查异常堆栈信息

### 问题3：有💾日志但显示保存失败

**症状**：看到 `💾 ❌ 保存到数据库失败`

**原因**：数据库操作失败

**排查**：
- 检查数据库初始化
- 查看错误堆栈
- 确认数据库权限

### 问题4：保存成功但重启后读取失败

**症状**：开启开关成功，但重启后 `📖 ❌ 值为 null，返回 null`

**原因**：数据库中的值没有正确保存

**排查**：
- 查看 `从数据库加载了 X 个设置项`
- 查看 `内存存储内容` 是否包含 `voiceEnabled`
- 检查数据库文件

### 问题5：读取成功但UI没有更新

**症状**：看到 `📖 ✅ 字符串 "true" 转换为布尔值 true` 但开关还是关闭状态

**原因**：UI没有响应状态变化

**排查**：
- 查看 `🔍 Consumer2 builder 被调用: voiceEnabled=?`
- 确认 `notifyListeners()` 被调用
- 检查 SettingsScreen 是否正确使用了 Consumer

## 📊 日志示例模板

请按照以下模板提供日志信息：

```markdown
### 测试结果
- 设备型号：[鸿蒙设备型号]
- App版本：[版本号]
- 测试时间：[时间]

### 开启开关时的日志
[粘贴相关日志]

### 重启后启动时的日志
[粘贴相关日志]

### 进入设置页面时的日志
[粘贴相关日志]

### 实际现象
- 开关是否自动开启：[是/否]
- 是否有错误提示：[是/否]
```

## 📝 日志收集工具

如果日志太多，可以使用以下命令筛选：

```bash
# 保存所有包含voiceEnabled的日志
adb logcat | grep voiceEnabled > voice_log.txt

# 或者只保存关键操作日志
adb logcat | grep -E "🚀|💾|📖|🔍" > key_log.txt
```

## 🎯 下一步

收集完整日志后，可以根据日志判断问题所在：

1. **如果完全没有日志** → 可能是日志级别被过滤了
2. **如果有日志但值不对** → 可能是类型转换问题
3. **如果日志都正常但UI没更新** → 可能是Provider绑定问题
4. **如果保存失败** → 可能是数据库或权限问题

请将完整的日志信息发送给开发者进行进一步分析。

